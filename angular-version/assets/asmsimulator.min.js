/*! asmsimulator 12-03-2025 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(I){return{go:function(e){for(var r=/^[\t ]*(?:([.A-Za-z]\w*)[\t ]*[:])?(?:[\t ]*([A-Za-z]{1,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,i=/^[-+]?[0-9]+$/,t=/^[.A-Za-z]\w*$/,p=[],s={},o={},R={},n=e.split("\n"),l=function(e){if("0x"===e.slice(0,2))return parseInt(e.slice(2),16);if("0o"===e.slice(0,2))return parseInt(e.slice(2),8);if("b"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),2);if("d"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),10);if(i.exec(e))return parseInt(e,10);throw"Invalid number format"},_=function(e){return"A"===(e=e.toUpperCase())?0:"B"===e?1:"C"===e?2:"D"===e?3:"SP"===e?4:void 0},E=function(e){var r=0,i=0;if("A"===(e=e.toUpperCase())[0])i=0;else if("B"===e[0])i=1;else if("C"===e[0])i=2;else if("D"===e[0])i=3;else{if("SP"!==e.slice(0,2))return;i=4}var t=4===i?2:1;if("-"===e[t])r=-1;else{if("+"!==e[t])return;r=1}r*=parseInt(e.slice(t+1),10);if(r<-16||15<r)throw"offset must be a value between -16...+15";return 8*(r=r<0?32+r:r)+i},d=function(e,r,i){var t=_(e);if(void 0!==t)return{type:r,value:t};var a=S(e);if(void 0!==a)return{type:i,value:a};if("regaddress"===r&&void 0!==(t=E(e)))return{type:r,value:t};a=l(e);if(isNaN(a))throw"Not a "+i+": "+a;if(a<0||65535<a)throw i+" must have a value between 0-65535";return{type:i,value:a}},S=function(e){return t.exec(e)?e:void 0},c=function(e){switch(e.slice(0,1)){case"[":var r=e.slice(1,e.length-1);return d(r,"regaddress","address");case'"':for(var i=e.slice(1,e.length-1),t=[],a=0,p=i.length;a<p;a++)t.push(i.charCodeAt(a));return{type:"numbers",value:t};case"'":r=e.slice(1,e.length-1);if(1<r.length)throw"Only one character is allowed. Use String instead";return{type:"number",value:r.charCodeAt(0)};default:return d(e,"register","number")}},D=function(e,r){if(void 0!==r)throw e+": too many arguments"},u=function(e){isNaN(e)?p.push(e,0):p.push(e>>8&255,255&e)},g=0,f=n.length;g<f;g++)try{var G=r.exec(n[g]);if(void 0!==G[1]||void 0!==G[2]){if(void 0!==G[1]){h=A=void 0;var A=G[1],h=A.toUpperCase();if(h in R)throw"Duplicate label: "+A;if("A"===h||"B"===h||"C"===h||"D"===h)throw"Label contains keyword: "+h;o[A]=p.length}if(void 0!==G[2]){var y,M,k,H=G[2].toUpperCase();switch("DB"!==H&&(s[p.length]=g),H){case"DB":if("number"===(y=c(G[3])).type)u(y.value);else if("numbers"===y.type)for(var m=0,v=y.value.length;m<v;m++)p.push(0,y.value[m]);else{if("address"!==y.type)throw"DB does not support this operand : "+y.type;p.push(y.value,0)}break;case"HLT":D("HLT",G[3]),u(k=I.NONE);break;case"MOV":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.MOV_REG_TO_REG;else if("register"===y.type&&"address"===M.type)k=I.MOV_ADDRESS_TO_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.MOV_REGADDRESS_TO_REG;else if("number"===y.type&&"register"===M.type)k=I.MOV_REG_TO_ADDRESS;else if("regaddress"===y.type&&"register"===M.type)k=I.MOV_REG_TO_REGADDRESS;else if("register"===y.type&&"number"===M.type)k=I.MOV_NUMBER_TO_REG;else if("number"===y.type&&"number"===M.type)k=I.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==y.type||"number"!==M.type)throw"MOV does not support this operands";k=I.MOV_NUMBER_TO_REGADDRESS}u(k),u(y.value),u(M.value);break;case"ADD":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.ADD_REG_TO_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.ADD_REGADDRESS_TO_REG;else if("register"===y.type&&"address"===M.type)k=I.ADD_ADDRESS_TO_REG;else{if("register"!==y.type||"number"!==M.type)throw"ADD does not support this operands";k=I.ADD_NUMBER_TO_REG}u(k),u(y.value),u(M.value);break;case"SUB":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.SUB_REG_FROM_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.SUB_REGADDRESS_FROM_REG;else if("register"===y.type&&"address"===M.type)k=I.SUB_ADDRESS_FROM_REG;else{if("register"!==y.type||"number"!==M.type)throw"SUB does not support this operands";k=I.SUB_NUMBER_FROM_REG}u(k),u(y.value),u(M.value);break;case"INC":if(y=c(G[3]),D("INC",G[7]),"register"!==y.type)throw"INC does not support this operand";k=I.INC_REG,p.push(k>>8&255,255&k,y.value>>8&255,255&y.value);break;case"DEC":if(y=c(G[3]),D("DEC",G[7]),"register"!==y.type)throw"DEC does not support this operand";k=I.DEC_REG,p.push(k>>8&255,255&k,y.value>>8&255,255&y.value);break;case"CMP":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.CMP_REG_WITH_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.CMP_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===M.type)k=I.CMP_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==M.type)throw"CMP does not support this operands";k=I.CMP_NUMBER_WITH_REG}u(k),u(y.value),u(M.value);break;case"JMP":if(y=c(G[3]),D("JMP",G[7]),"register"===y.type)k=I.JMP_REGADDRESS;else{if("number"!==y.type)throw"JMP does not support this operands";k=I.JMP_ADDRESS}u(k),u(y.value);break;case"JC":case"JB":case"JNAE":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.JC_REGADDRESS;else{if("number"!==y.type)throw H+" does not support this operand";k=I.JC_ADDRESS}u(k),u(y.value);break;case"JNC":case"JNB":case"JAE":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.JNC_REGADDRESS;else{if("number"!==y.type)throw H+"does not support this operand";k=I.JNC_ADDRESS}u(k),u(y.value);break;case"JZ":case"JE":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.JZ_REGADDRESS;else{if("number"!==y.type)throw H+" does not support this operand";k=I.JZ_ADDRESS}u(k),u(y.value);break;case"JNZ":case"JNE":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.JNZ_REGADDRESS;else{if("number"!==y.type)throw H+" does not support this operand";k=I.JNZ_ADDRESS}u(k),u(y.value);break;case"JA":case"JNBE":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.JA_REGADDRESS;else{if("number"!==y.type)throw H+" does not support this operand";k=I.JA_ADDRESS}u(k),u(y.value);break;case"JNA":case"JBE":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.JNA_REGADDRESS;else{if("number"!==y.type)throw H+" does not support this operand";k=I.JNA_ADDRESS}u(k),u(y.value);break;case"PUSH":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.PUSH_REG;else if("regaddress"===y.type)k=I.PUSH_REGADDRESS;else if("address"===y.type)k=I.PUSH_ADDRESS;else{if("number"!==y.type)throw"PUSH does not support this operand";k=I.PUSH_NUMBER}u(k),u(y.value);break;case"POP":if(y=c(G[3]),D(H,G[7]),"register"!==y.type)throw"PUSH does not support this operand";k=I.POP_REG,p.push(k>>8&255,255&k,y.value>>8&255,255&y.value);break;case"CALL":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.CALL_REGADDRESS;else{if("number"!==y.type)throw"CALL does not support this operand";k=I.CALL_ADDRESS}u(k),u(y.value);break;case"RET":D(H,G[3]),u(k=I.RET);break;case"MUL":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.MUL_REG;else if("regaddress"===y.type)k=I.MUL_REGADDRESS;else if("address"===y.type)k=I.MUL_ADDRESS;else{if("number"!==y.type)throw"MULL does not support this operand";k=I.MUL_NUMBER}u(k),u(y.value);break;case"DIV":if(y=c(G[3]),D(H,G[7]),"register"===y.type)k=I.DIV_REG;else if("regaddress"===y.type)k=I.DIV_REGADDRESS;else if("address"===y.type)k=I.DIV_ADDRESS;else{if("number"!==y.type)throw"DIV does not support this operand";k=I.DIV_NUMBER}u(k),u(y.value);break;case"AND":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.AND_REG_WITH_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.AND_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===M.type)k=I.AND_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==M.type)throw"AND does not support this operands";k=I.AND_NUMBER_WITH_REG}u(k),u(y.value),u(M.value);break;case"OR":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.OR_REG_WITH_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.OR_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===M.type)k=I.OR_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==M.type)throw"OR does not support this operands";k=I.OR_NUMBER_WITH_REG}u(k),u(y.value),u(M.value);break;case"XOR":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.XOR_REG_WITH_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.XOR_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===M.type)k=I.XOR_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==M.type)throw"XOR does not support this operands";k=I.XOR_NUMBER_WITH_REG}u(k),u(y.value),u(M.value);break;case"NOT":if(y=c(G[3]),D(H,G[7]),"register"!==y.type)throw"NOT does not support this operand";u(k=I.NOT_REG),u(y.value);break;case"SHL":case"SAL":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.SHL_REG_WITH_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.SHL_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===M.type)k=I.SHL_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==M.type)throw H+" does not support this operands";k=I.SHL_NUMBER_WITH_REG}u(k),u(y.value),u(M.value);break;case"SHR":case"SAR":if(y=c(G[3]),M=c(G[7]),"register"===y.type&&"register"===M.type)k=I.SHR_REG_WITH_REG;else if("register"===y.type&&"regaddress"===M.type)k=I.SHR_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===M.type)k=I.SHR_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==M.type)throw H+" does not support this operands";k=I.SHR_NUMBER_WITH_REG}u(k),u(y.value),u(M.value);break;default:throw"Invalid instruction: "+G[2]}}}else{var T=n[g].trim();if(""!==T&&";"!==T.slice(0,1))throw"Syntax error"}}catch(e){throw{error:e,line:g}}for(g=0;g<o.size;g++);for(g=0,f=p.length;g<f;g++)if(isNaN(p[g])){if(!(p[g]in o))throw{error:"Undefined label: "+p[g]};a=g,b=g+1,lab=o[p[g]],p[g]=lab>>8&255,p[++g]=255&lab}return{code:p,mapping:s,labels:o}}}}]),app.service("cpu",["opcodes","memory",function(u,g){var e={step:function(){var i=this;if(!0===i.fault)throw"FAULT. Reset to continue.";try{var e,r,t,a,p,s=function(e){if(e<0||e>=i.gpr.length)throw"Invalid register: "+e;return e},o=function(e){if(e<0||e>=1+i.gpr.length)throw"Invalid register: "+e;return e},R=function(e,r){if(0<=e&&e<i.gpr.length)i.gpr[e]=r;else{if(e!=i.gpr.length)throw"Invalid register: "+e;if(i.sp=r,i.sp<i.minSP)throw"Stack overflow";if(i.sp>i.maxSP)throw"Stack underflow"}},n=function(e){if(0<=e&&e<i.gpr.length)return i.gpr[e];if(e==i.gpr.length)return i.sp;throw"Invalid register: "+e},l=function(e){var r=e%8,r=r<i.gpr.length?i.gpr[r]:i.sp,e=Math.floor(e/8);return 15<e&&(e-=32),r+e},_=function(e){return i.zero=!1,i.carry=!1,65536<=e?(i.carry=!0,e%=65536):0===e?i.zero=!0:e<0&&(i.carry=!0,e=65536- -e%65536),e},E=function(e){if(e<0||e>=g.data.length)throw"IP outside memory";i.ip=e},d=function(e){if(i.sp-=2,g.store16(i.sp,e),i.sp<i.minSP)throw"Stack overflow"},S=function(){var e=g.load16(i.sp);if(i.sp+=2,i.sp>i.maxSP)throw"Stack underflow";return e},c=function(e){if(0===e)throw"Division by 0";return Math.floor(i.gpr[0]/e)};if(i.ip<0||i.ip>=g.data.length)throw"Instruction pointer is outside of memory";var D=g.load16(i.ip);switch(i.ip++,D){case u.NONE:return!1;case u.MOV_REG_TO_REG:e=o(g.load16(++i.ip)),i.ip++,r=o(g.load16(++i.ip)),i.ip++,R(e,n(r)),i.ip++;break;case u.MOV_ADDRESS_TO_REG:e=o(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,R(e,g.load16(t)),i.ip++;break;case u.MOV_REGADDRESS_TO_REG:e=o(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,R(e,g.load16(l(r))),i.ip++;break;case u.MOV_REG_TO_ADDRESS:a=g.load16(++i.ip),i.ip++,r=o(g.load16(++i.ip)),i.ip++,g.store16(a,n(r)),i.ip++;break;case u.MOV_REG_TO_REGADDRESS:e=g.load16(++i.ip),i.ip++,r=o(g.load16(++i.ip)),i.ip++,g.store16(l(e),n(r)),i.ip++;break;case u.MOV_NUMBER_TO_REG:e=o(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,R(e,p),i.ip++;break;case u.MOV_NUMBER_TO_ADDRESS:a=g.load16(++i.ip),i.ip++,p=g.load16(++i.ip),i.ip++,g.store16(a,p),i.ip++;break;case u.MOV_NUMBER_TO_REGADDRESS:e=g.load16(++i.ip),i.ip++,p=g.load16(++i.ip),i.ip++,g.store16(l(e),p),i.ip++;break;case u.ADD_REG_TO_REG:e=o(g.load16(++i.ip)),i.ip++,r=o(g.load16(++i.ip)),i.ip++,R(e,_(n(e)+n(r))),i.ip++;break;case u.ADD_REGADDRESS_TO_REG:e=o(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,R(e,_(n(e)+g.load16(l(r)))),i.ip++;break;case u.ADD_ADDRESS_TO_REG:e=o(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,R(e,_(n(e)+g.load16(t))),i.ip++;break;case u.ADD_NUMBER_TO_REG:e=o(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,R(e,_(n(e)+p)),i.ip++;break;case u.SUB_REG_FROM_REG:e=o(g.load16(++i.ip)),i.ip++,r=o(g.load16(++i.ip)),i.ip++,R(e,_(n(e)-i.gpr[r])),i.ip++;break;case u.SUB_REGADDRESS_FROM_REG:e=o(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,R(e,_(n(e)-g.load16(l(r)))),i.ip++;break;case u.SUB_ADDRESS_FROM_REG:e=o(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,R(e,_(n(e)-g.load16(t))),i.ip++;break;case u.SUB_NUMBER_FROM_REG:e=o(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,R(e,_(n(e)-p)),i.ip++;break;case u.INC_REG:e=o(g.load16(++i.ip)),i.ip++,R(e,_(n(e)+1)),i.ip++;break;case u.DEC_REG:e=o(g.load16(++i.ip)),i.ip++,R(e,_(n(e)-1)),i.ip++;break;case u.CMP_REG_WITH_REG:e=o(g.load16(++i.ip)),i.ip++,r=o(g.load16(++i.ip)),i.ip++,_(n(e)-n(r)),i.ip++;break;case u.CMP_REGADDRESS_WITH_REG:e=o(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,_(n(e)-g.load16(l(r))),i.ip++;break;case u.CMP_ADDRESS_WITH_REG:e=o(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,_(n(e)-g.load16(t)),i.ip++;break;case u.CMP_NUMBER_WITH_REG:e=o(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,_(n(e)-p),i.ip++;break;case u.JMP_REGADDRESS:e=s(g.load16(++i.ip)),i.ip++,E(i.gpr[e]);break;case u.JMP_ADDRESS:p=g.load16(++i.ip),i.ip++,E(p);break;case u.JC_REGADDRESS:e=s(g.load16(++i.ip)),i.ip++,i.carry?E(i.gpr[e]):i.ip++;break;case u.JC_ADDRESS:p=g.load16(++i.ip),i.ip++,i.carry?E(p):i.ip++;break;case u.JNC_REGADDRESS:e=s(g.load16(++i.ip)),i.ip++,i.carry?i.ip++:E(i.gpr[e]);break;case u.JNC_ADDRESS:p=g.load16(++i.ip),i.ip++,i.carry?i.ip++:E(p);break;case u.JZ_REGADDRESS:e=s(g.load16(++i.ip)),i.ip++,i.zero?E(i.gpr[e]):i.ip++;break;case u.JZ_ADDRESS:p=g.load16(++i.ip),i.ip++,i.zero?E(p):i.ip++;break;case u.JNZ_REGADDRESS:e=s(g.load16(++i.ip)),i.ip++,i.zero?i.ip++:E(i.gpr[e]);break;case u.JNZ_ADDRESS:p=g.load16(++i.ip),i.ip++,i.zero?i.ip++:E(p);break;case u.JA_REGADDRESS:e=s(g.load16(++i.ip)),i.ip++,i.zero||i.carry?i.ip++:E(i.gpr[e]);break;case u.JA_ADDRESS:p=g.load16(++i.ip),i.ip++,i.zero||i.carry?i.ip++:E(p);break;case u.JNA_REGADDRESS:e=s(g.load16(++i.ip)),i.ip++,i.zero||i.carry?E(i.gpr[e]):i.ip++;break;case u.JNA_ADDRESS:p=g.load16(++i.ip),i.ip++,i.zero||i.carry?E(p):i.ip++;break;case u.PUSH_REG:r=s(g.load16(++i.ip)),i.ip++,d(i.gpr[r]),i.ip++;break;case u.PUSH_REGADDRESS:r=g.load16(++i.ip),i.ip++,d(g.load16(l(r))),i.ip++;break;case u.PUSH_ADDRESS:t=g.load16(++i.ip),i.ip++,d(g.load16(t)),i.ip++;break;case u.PUSH_NUMBER:p=g.load16(++i.ip),i.ip++,d(p),i.ip++;break;case u.POP_REG:e=s(g.load16(++i.ip)),i.ip++,i.gpr[e]=S(),i.ip++;break;case u.CALL_REGADDRESS:e=s(g.load16(++i.ip)),d(i.ip+2),E(i.gpr[e]);break;case u.CALL_ADDRESS:p=g.load16(++i.ip),d(i.ip+2),E(p);break;case u.RET:E(jump_addr=S());break;case u.MUL_REG:r=s(g.load16(++i.ip)),i.ip++,i.gpr[0]=_(i.gpr[0]*i.gpr[r]),i.ip++;break;case u.MUL_REGADDRESS:r=g.load16(++i.ip),i.ip++,i.gpr[0]=_(i.gpr[0]*g.load16(l(r))),i.ip++;break;case u.MUL_ADDRESS:t=g.load16(++i.ip),i.ip++,i.gpr[0]=_(i.gpr[0]*g.load16(t)),i.ip++;break;case u.MUL_NUMBER:p=g.load16(++i.ip),i.ip++,i.gpr[0]=_(i.gpr[0]*p),i.ip++;break;case u.DIV_REG:r=s(g.load16(++i.ip)),i.ip++,i.gpr[0]=_(c(i.gpr[r])),i.ip++;break;case u.DIV_REGADDRESS:r=g.load16(++i.ip),i.ip++,i.gpr[0]=_(c(g.load16(l(r)))),i.ip++;break;case u.DIV_ADDRESS:t=g.load16(++i.ip),i.ip++,i.gpr[0]=_(c(g.load16(t))),i.ip++;break;case u.DIV_NUMBER:p=g.load16(++i.ip),i.ip++,i.gpr[0]=_(c(p)),i.ip++;break;case u.AND_REG_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=s(g.load16(++i.ip)),i.ip++,i.gpr[e]=_(i.gpr[e]&i.gpr[r]),i.ip++;break;case u.AND_REGADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]&g.load16(l(r))),i.ip++;break;case u.AND_ADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]&g.load16(t)),i.ip++;break;case u.AND_NUMBER_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]&p),i.ip++;break;case u.OR_REG_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=s(g.load16(++i.ip)),i.ip++,i.gpr[e]=_(i.gpr[e]|i.gpr[r]),i.ip++;break;case u.OR_REGADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]|g.load16(l(r))),i.ip++;break;case u.OR_ADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]|g.load16(t)),i.ip++;break;case u.OR_NUMBER_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]|p),i.ip++;break;case u.XOR_REG_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=s(g.load16(++i.ip)),i.ip++,i.gpr[e]=_(i.gpr[e]^i.gpr[r]),i.ip++;break;case u.XOR_REGADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]^g.load16(l(r))),i.ip++;break;case u.XOR_ADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]^g.load16(t)),i.ip++;break;case u.XOR_NUMBER_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]^p),i.ip++;break;case u.NOT_REG:e=s(g.load16(++i.ip)),i.ip++,i.gpr[e]=_(~i.gpr[e]),i.ip++;break;case u.SHL_REG_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=s(g.load16(++i.ip)),i.ip++,i.gpr[e]=_(i.gpr[e]<<i.gpr[r]),i.ip++;break;case u.SHL_REGADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]<<g.load16(l(r))),i.ip++;break;case u.SHL_ADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]<<g.load16(t)),i.ip++;break;case u.SHL_NUMBER_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]<<p),i.ip++;break;case u.SHR_REG_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=s(g.load16(++i.ip)),i.ip++,i.gpr[e]=_(i.gpr[e]>>>i.gpr[r]),i.ip++;break;case u.SHR_REGADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,r=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]>>>g.load16(l(r))),i.ip++;break;case u.SHR_ADDRESS_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,t=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]>>>g.load16(t)),i.ip++;break;case u.SHR_NUMBER_WITH_REG:e=s(g.load16(++i.ip)),i.ip++,p=g.load16(++i.ip),i.ip++,i.gpr[e]=_(i.gpr[e]>>>p),i.ip++;break;default:throw"Invalid op code: "+D}return!0}catch(e){throw i.fault=!0,e}},reset:function(){var e=this;e.maxSP=924,e.minSP=0,e.gpr=[0,0,0,0],e.sp=e.maxSP,e.ip=0,e.zero=!1,e.carry=!1,e.fault=!1}};return e.reset(),e}]),app.service("memory",[function(){var e={data:Array(1024),lastAccess:-1,load:function(e){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;return this.lastAccess=e,this.data[e]},load16:function(e){if(e<0||e+1>=this.data.length)throw"Memory access violation at "+e;return this.lastAccess=e,(this.data[e]<<8)+this.data[e+1]},store:function(e,r){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;this.lastAccess=e,this.data[e]=r},store16:function(e,r){if(e<0||e+1>=this.data.length)throw"Memory access violation at "+e;this.lastAccess=e,this.data[e]=r>>8&255,this.data[e+1]=255&r},reset:function(){this.lastAccess=-1;for(var e=0,r=this.data.length;e<r;e++)this.data[e]=0}};return e.reset(),e}]),app.service("opcodes",[function(){return{NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97}}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(r,a,e,i,p,s){var t;a.memory=p,a.cpu=i,a.error="",a.isRunning=!1,a.displayHex=!0,a.displayInstr=!0,a.displayA=!0,a.displayB=!0,a.displayC=!0,a.displayD=!0,a.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"},{speed:1024,desc:"1024 HZ"}],a.speed=4,a.outputStartIndex=925,a.ramDisplayMode="HEX",a.code=["; Simple example","; Writes Hello World to the output","   JMP start",'hello: DB "Hello World!" ; Variable',"       DB 0\t; String terminator","start:","   MOV D, hello    ; Point to var","   PUSH 925\t; Point to output","   CALL print","   HLT             ; Stop execution","print:\t\t; print(D:*from, SP+2:*to)","   PUSH C","   PUSH B","   MOV C, [SP+6]","   MOV B, 0",".loop:","   MOV A, [D]\t; Get char from var","   MOV [C], A\t; Write to output","   INC D","   INC C","   INC D","   INC C","   CMP B, [D]\t; Check if end","   JNZ .loop\t; jump if not","   POP B","   POP C","   RET"].join("\n"),a.reset=function(){i.reset(),p.reset(),a.error="",a.selectedLine=-1},a.downloadCode=function(){var e=document.createElement("a"),r=a.code,r=new Blob([r],{type:"text/plain"});e.href=URL.createObjectURL(r),e.download="code.asm",document.body.appendChild(e),e.click(),URL.revokeObjectURL(e.href),document.body.removeChild(e)},a.loadFile=function(){var e=document.querySelector("input").files[0],r=(console.log(e),new FileReader);r.addEventListener("load",function(e){a.code=e.target.result,a.$apply()}),r.readAsText(e,"UTF-8")},a.executeStep=function(){a.checkPrgrmLoaded()||a.assemble();try{var e=i.step();return i.ip in a.mapping&&(a.selectedLine=a.mapping[i.ip]),e}catch(e){return a.error=e,!1}},a.run=function(){a.checkPrgrmLoaded()||a.assemble(),a.isRunning=!0,t=e(function(){!0===a.executeStep()?a.run():a.isRunning=!1},1e3/a.speed)},a.runQuickly=function(){a.checkPrgrmLoaded()||a.assemble(),a.isRunning=!0,t=e(function(){!0===a.executeStep()?a.runQuickly():a.isRunning=!1},1)},a.stop=function(){e.cancel(t),a.isRunning=!1},a.checkPrgrmLoaded=function(){for(var e=0,r=p.data.length;e<r;e++)if(0!==p.data[e])return!0;return!1},a.getChar=function(e){e=String.fromCharCode(e);return""===e.trim()?"  ":e},a.get8HigherBits=function(e){return e>>8&255},a.get8LowerBits=function(e){return 255&e},a.assemble=function(){try{a.reset();var e=s.go(a.code),r=(a.mapping=e.mapping,e.code);if(a.labels=e.labels,r.length>p.data.length)throw"Binary code does not fit into the memory. Max "+p.data.length+" bytes are allowed";for(var i=0,t=r.length;i<t;i++)p.data[i]=r[i]}catch(e){void 0!==e.line?(a.error=e.line+" | "+e.error,a.selectedLine=e.line):a.error=e.error}},a.jumpToLine=function(e){r[0].getElementById("sourceCode").scrollIntoView(),a.selectedLine=a.mapping[e]},a.isInstruction=function(e){return void 0!==a.mapping&&void 0!==a.mapping[e]&&a.displayInstr},a.getMemoryCellCss=function(e){return e>=a.outputStartIndex?"output-bg":a.isInstruction(e)?"instr-bg":e>i.sp&&e<=i.maxSP?"stack-bg":""},a.getMemoryInnerCellCss=function(e){return e===i.ip?"marker marker-ip":e===i.sp?"marker marker-sp":e===i.gpr[0]&&a.displayA?"marker marker-a":e===i.gpr[1]&&a.displayB?"marker marker-b":e===i.gpr[2]&&a.displayC?"marker marker-c":e===i.gpr[3]&&a.displayD?"marker marker-d":""},a.changeRamDisplayMode=function(){"ASCII"===a.ramDisplayMode?a.ramDisplayMode="HEX":a.ramDisplayMode="ASCII"}}]),app.filter("flag",function(){return function(e){return e.toString().toUpperCase()}}),app.filter("number",function(){return function(e,r){return r?1==(r=e.toString(16).toUpperCase()).length?"0"+r:r:e.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(p,s,e,r){p.$watch("selectedLine",function(){if(0<=p.selectedLine){for(var e=s[0].value.split("\n"),r=0,i=0;i<e.length&&i!=p.selectedLine;i++)r+=e[i].length+1;var t,a=e[p.selectedLine].length+r;void 0!==s[0].selectionStart&&(s[0].focus(),s[0].selectionStart=r,s[0].selectionEnd=a),document.selection&&document.selection.createRange&&(s[0].focus(),s[0].select(),(t=document.selection.createRange()).collapse(!0),t.moveEnd("character",a),t.moveStart("character",r),t.select())}})}}}]),app.filter("startFrom",function(){return function(e,r){return e.slice(r=+r)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(e,r,i,t){r.bind("keydown",function(e){var r,i,t;if(9===e.keyCode)return r=this.value,i=this.selectionStart,t=this.selectionEnd,this.value=r.substring(0,i)+"\t"+r.substring(t),this.selectionStart=this.selectionEnd=i+1,e.preventDefault(),!1})}}}]);