/*! asmsimulator 13-03-2025 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(T){return{go:function(e){for(var r=/^[\t ]*(?:([.A-Za-z]\w*)[\t ]*[:])?(?:[\t ]*([A-Za-z]{1,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,t=/^[-+]?[0-9]+$/,i=/^[.A-Za-z]\w*$/,p=[],s={},o={},n={},l=e.split("\n"),R=function(e){if("0x"===e.slice(0,2))return parseInt(e.slice(2),16);if("0o"===e.slice(0,2))return parseInt(e.slice(2),8);if("b"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),2);if("d"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),10);if(t.exec(e))return parseInt(e,10);throw"Invalid number format"},_=function(e){return"A"===(e=e.toUpperCase())?0:"B"===e?1:"C"===e?2:"D"===e?3:"SP"===e?4:void 0},d=function(e){var r=0,t=0;if("A"===(e=e.toUpperCase())[0])t=0;else if("B"===e[0])t=1;else if("C"===e[0])t=2;else if("D"===e[0])t=3;else{if("SP"!==e.slice(0,2))return;t=4}var i=4===t?2:1;if("-"===e[i])r=-1;else{if("+"!==e[i])return;r=1}r*=parseInt(e.slice(i+1),10);if(r<-16||15<r)throw"offset must be a value between -16...+15";return 8*(r=r<0?32+r:r)+t},c=function(e,r,t){var i=_(e);if(void 0!==i)return{type:r,value:i};var a=E(e);if(void 0!==a)return{type:t,value:a};if("regaddress"===r&&void 0!==(i=d(e)))return{type:r,value:i};a=R(e);if(isNaN(a))throw"Not a "+t+": "+a;if(a<0||65535<a)throw t+" must have a value between 0-65535";return{type:t,value:a}},E=function(e){return i.exec(e)?e:void 0},S=function(e){switch(e.slice(0,1)){case"[":var r=e.slice(1,e.length-1);return c(r,"regaddress","address");case'"':for(var t=e.slice(1,e.length-1),i=[],a=0,p=t.length;a<p;a++)i.push(t.charCodeAt(a));return{type:"numbers",value:i};case"'":r=e.slice(1,e.length-1);if(1<r.length)throw"Only one character is allowed. Use String instead";return{type:"number",value:r.charCodeAt(0)};default:return c(e,"register","number")}},u=function(e,r){if(void 0!==r)throw e+": too many arguments"},D=function(e){isNaN(e)?p.push(e,0):p.push(e>>8&255,255&e)},g=0,f=l.length;g<f;g++)try{var G=r.exec(l[g]);if(void 0!==G[1]||void 0!==G[2]){if(void 0!==G[1]){h=A=void 0;var A=G[1],h=A.toUpperCase();if(h in n)throw"Duplicate label: "+A;if("A"===h||"B"===h||"C"===h||"D"===h)throw"Label contains keyword: "+h;o[A]=p.length}if(void 0!==G[2]){var y,v,M,m=G[2].toUpperCase();switch("DB"!==m&&(s[p.length]=g),m){case"DB":if("number"===(y=S(G[3])).type)D(y.value);else if("numbers"===y.type)for(var H=0,k=y.value.length;H<k;H++)p.push(0,y.value[H]);else{if("address"!==y.type)throw"DB does not support this operand : "+y.type;p.push(y.value,0)}break;case"HLT":u("HLT",G[3]),D(M=T.NONE);break;case"MOV":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.MOV_REG_TO_REG;else if("register"===y.type&&"address"===v.type)M=T.MOV_ADDRESS_TO_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.MOV_REGADDRESS_TO_REG;else if("number"===y.type&&"register"===v.type)M=T.MOV_REG_TO_ADDRESS;else if("regaddress"===y.type&&"register"===v.type)M=T.MOV_REG_TO_REGADDRESS;else if("register"===y.type&&"number"===v.type)M=T.MOV_NUMBER_TO_REG;else if("number"===y.type&&"number"===v.type)M=T.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==y.type||"number"!==v.type)throw"MOV does not support this operands";M=T.MOV_NUMBER_TO_REGADDRESS}D(M),D(y.value),D(v.value);break;case"ADD":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.ADD_REG_TO_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.ADD_REGADDRESS_TO_REG;else if("register"===y.type&&"address"===v.type)M=T.ADD_ADDRESS_TO_REG;else{if("register"!==y.type||"number"!==v.type)throw"ADD does not support this operands";M=T.ADD_NUMBER_TO_REG}D(M),D(y.value),D(v.value);break;case"SUB":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.SUB_REG_FROM_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.SUB_REGADDRESS_FROM_REG;else if("register"===y.type&&"address"===v.type)M=T.SUB_ADDRESS_FROM_REG;else{if("register"!==y.type||"number"!==v.type)throw"SUB does not support this operands";M=T.SUB_NUMBER_FROM_REG}D(M),D(y.value),D(v.value);break;case"INC":if(y=S(G[3]),u("INC",G[7]),"register"!==y.type)throw"INC does not support this operand";M=T.INC_REG,p.push(M>>8&255,255&M,y.value>>8&255,255&y.value);break;case"DEC":if(y=S(G[3]),u("DEC",G[7]),"register"!==y.type)throw"DEC does not support this operand";M=T.DEC_REG,p.push(M>>8&255,255&M,y.value>>8&255,255&y.value);break;case"CMP":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.CMP_REG_WITH_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.CMP_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===v.type)M=T.CMP_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==v.type)throw"CMP does not support this operands";M=T.CMP_NUMBER_WITH_REG}D(M),D(y.value),D(v.value);break;case"JMP":if(y=S(G[3]),u("JMP",G[7]),"register"===y.type)M=T.JMP_REGADDRESS;else{if("number"!==y.type)throw"JMP does not support this operands";M=T.JMP_ADDRESS}D(M),D(y.value);break;case"JC":case"JB":case"JNAE":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.JC_REGADDRESS;else{if("number"!==y.type)throw m+" does not support this operand";M=T.JC_ADDRESS}D(M),D(y.value);break;case"JNC":case"JNB":case"JAE":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.JNC_REGADDRESS;else{if("number"!==y.type)throw m+"does not support this operand";M=T.JNC_ADDRESS}D(M),D(y.value);break;case"JZ":case"JE":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.JZ_REGADDRESS;else{if("number"!==y.type)throw m+" does not support this operand";M=T.JZ_ADDRESS}D(M),D(y.value);break;case"JNZ":case"JNE":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.JNZ_REGADDRESS;else{if("number"!==y.type)throw m+" does not support this operand";M=T.JNZ_ADDRESS}D(M),D(y.value);break;case"JA":case"JNBE":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.JA_REGADDRESS;else{if("number"!==y.type)throw m+" does not support this operand";M=T.JA_ADDRESS}D(M),D(y.value);break;case"JNA":case"JBE":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.JNA_REGADDRESS;else{if("number"!==y.type)throw m+" does not support this operand";M=T.JNA_ADDRESS}D(M),D(y.value);break;case"PUSH":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.PUSH_REG;else if("regaddress"===y.type)M=T.PUSH_REGADDRESS;else if("address"===y.type)M=T.PUSH_ADDRESS;else{if("number"!==y.type)throw"PUSH does not support this operand";M=T.PUSH_NUMBER}D(M),D(y.value);break;case"POP":if(y=S(G[3]),u(m,G[7]),"register"!==y.type)throw"PUSH does not support this operand";M=T.POP_REG,p.push(M>>8&255,255&M,y.value>>8&255,255&y.value);break;case"CALL":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.CALL_REGADDRESS;else{if("number"!==y.type)throw"CALL does not support this operand";M=T.CALL_ADDRESS}D(M),D(y.value);break;case"RET":u(m,G[3]),D(M=T.RET);break;case"MUL":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.MUL_REG;else if("regaddress"===y.type)M=T.MUL_REGADDRESS;else if("address"===y.type)M=T.MUL_ADDRESS;else{if("number"!==y.type)throw"MULL does not support this operand";M=T.MUL_NUMBER}D(M),D(y.value);break;case"DIV":if(y=S(G[3]),u(m,G[7]),"register"===y.type)M=T.DIV_REG;else if("regaddress"===y.type)M=T.DIV_REGADDRESS;else if("address"===y.type)M=T.DIV_ADDRESS;else{if("number"!==y.type)throw"DIV does not support this operand";M=T.DIV_NUMBER}D(M),D(y.value);break;case"AND":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.AND_REG_WITH_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.AND_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===v.type)M=T.AND_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==v.type)throw"AND does not support this operands";M=T.AND_NUMBER_WITH_REG}D(M),D(y.value),D(v.value);break;case"OR":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.OR_REG_WITH_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.OR_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===v.type)M=T.OR_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==v.type)throw"OR does not support this operands";M=T.OR_NUMBER_WITH_REG}D(M),D(y.value),D(v.value);break;case"XOR":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.XOR_REG_WITH_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.XOR_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===v.type)M=T.XOR_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==v.type)throw"XOR does not support this operands";M=T.XOR_NUMBER_WITH_REG}D(M),D(y.value),D(v.value);break;case"NOT":if(y=S(G[3]),u(m,G[7]),"register"!==y.type)throw"NOT does not support this operand";D(M=T.NOT_REG),D(y.value);break;case"SHL":case"SAL":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.SHL_REG_WITH_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.SHL_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===v.type)M=T.SHL_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==v.type)throw m+" does not support this operands";M=T.SHL_NUMBER_WITH_REG}D(M),D(y.value),D(v.value);break;case"SHR":case"SAR":if(y=S(G[3]),v=S(G[7]),"register"===y.type&&"register"===v.type)M=T.SHR_REG_WITH_REG;else if("register"===y.type&&"regaddress"===v.type)M=T.SHR_REGADDRESS_WITH_REG;else if("register"===y.type&&"address"===v.type)M=T.SHR_ADDRESS_WITH_REG;else{if("register"!==y.type||"number"!==v.type)throw m+" does not support this operands";M=T.SHR_NUMBER_WITH_REG}D(M),D(y.value),D(v.value);break;default:throw"Invalid instruction: "+G[2]}}}else{var O=l[g].trim();if(""!==O&&";"!==O.slice(0,1))throw"Syntax error"}}catch(e){throw{error:e,line:g}}for(g=0;g<o.size;g++);for(g=0,f=p.length;g<f;g++)if(isNaN(p[g])){if(!(p[g]in o))throw{error:"Undefined label: "+p[g]};a=g,b=g+1,lab=o[p[g]],p[g]=lab>>8&255,p[++g]=255&lab}return{code:p,mapping:s,labels:o}}}}]),app.service("cpu",["opcodes","memory",function(D,g){var e={step:function(){var t=this;if(!0===t.fault)throw"FAULT. Reset to continue.";try{var e,r,i,a,p,s=function(e){if(e<0||e>=t.gpr.length)throw"Invalid register: "+e;return e},o=function(e){if(e<0||e>=1+t.gpr.length)throw"Invalid register: "+e;return e},n=function(e,r){if(0<=e&&e<t.gpr.length)t.gpr[e]=r;else{if(e!=t.gpr.length)throw"Invalid register: "+e;if(t.sp=r,t.sp<t.minSP)throw"Stack overflow";if(t.sp>t.maxSP)throw"Stack underflow"}},l=function(e){if(0<=e&&e<t.gpr.length)return t.gpr[e];if(e==t.gpr.length)return t.sp;throw"Invalid register: "+e},R=function(e){var r=e%8,r=r<t.gpr.length?t.gpr[r]:t.sp,e=Math.floor(e/8);return 15<e&&(e-=32),r+e},_=function(e){return t.zero=!1,t.carry=!1,65536<=e?(t.carry=!0,e%=65536):0===e?t.zero=!0:e<0&&(t.carry=!0,e=65536- -e%65536),e},d=function(e){if(e<0||e>=g.data.length)throw"IP outside memory";t.ip=e},c=function(e){if(t.sp-=2,g.store16(t.sp,e),t.sp<t.minSP)throw"Stack overflow"},E=function(){var e=g.load16(t.sp);if(t.sp+=2,t.sp>t.maxSP)throw"Stack underflow";return e},S=function(e){if(0===e)throw"Division by 0";return Math.floor(t.gpr[0]/e)};if(t.ip<0||t.ip>=g.data.length)throw"Instruction pointer is outside of memory";var u=g.load16(t.ip);switch(t.ip++,u){case D.NONE:return!1;case D.MOV_REG_TO_REG:e=o(g.load16(++t.ip)),t.ip++,r=o(g.load16(++t.ip)),t.ip++,n(e,l(r)),t.ip++;break;case D.MOV_ADDRESS_TO_REG:e=o(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,n(e,g.load16(i)),t.ip++;break;case D.MOV_REGADDRESS_TO_REG:e=o(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,n(e,g.load16(R(r))),t.ip++;break;case D.MOV_REG_TO_ADDRESS:a=g.load16(++t.ip),t.ip++,r=o(g.load16(++t.ip)),t.ip++,g.store16(a,l(r)),t.ip++;break;case D.MOV_REG_TO_REGADDRESS:e=g.load16(++t.ip),t.ip++,r=o(g.load16(++t.ip)),t.ip++,g.store16(R(e),l(r)),t.ip++;break;case D.MOV_NUMBER_TO_REG:e=o(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,n(e,p),t.ip++;break;case D.MOV_NUMBER_TO_ADDRESS:a=g.load16(++t.ip),t.ip++,p=g.load16(++t.ip),t.ip++,g.store16(a,p),t.ip++;break;case D.MOV_NUMBER_TO_REGADDRESS:e=g.load16(++t.ip),t.ip++,p=g.load16(++t.ip),t.ip++,g.store16(R(e),p),t.ip++;break;case D.ADD_REG_TO_REG:e=o(g.load16(++t.ip)),t.ip++,r=o(g.load16(++t.ip)),t.ip++,n(e,_(l(e)+l(r))),t.ip++;break;case D.ADD_REGADDRESS_TO_REG:e=o(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,n(e,_(l(e)+g.load16(R(r)))),t.ip++;break;case D.ADD_ADDRESS_TO_REG:e=o(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,n(e,_(l(e)+g.load16(i))),t.ip++;break;case D.ADD_NUMBER_TO_REG:e=o(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,n(e,_(l(e)+p)),t.ip++;break;case D.SUB_REG_FROM_REG:e=o(g.load16(++t.ip)),t.ip++,r=o(g.load16(++t.ip)),t.ip++,n(e,_(l(e)-t.gpr[r])),t.ip++;break;case D.SUB_REGADDRESS_FROM_REG:e=o(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,n(e,_(l(e)-g.load16(R(r)))),t.ip++;break;case D.SUB_ADDRESS_FROM_REG:e=o(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,n(e,_(l(e)-g.load16(i))),t.ip++;break;case D.SUB_NUMBER_FROM_REG:e=o(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,n(e,_(l(e)-p)),t.ip++;break;case D.INC_REG:e=o(g.load16(++t.ip)),t.ip++,n(e,_(l(e)+1)),t.ip++;break;case D.DEC_REG:e=o(g.load16(++t.ip)),t.ip++,n(e,_(l(e)-1)),t.ip++;break;case D.CMP_REG_WITH_REG:e=o(g.load16(++t.ip)),t.ip++,r=o(g.load16(++t.ip)),t.ip++,_(l(e)-l(r)),t.ip++;break;case D.CMP_REGADDRESS_WITH_REG:e=o(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,_(l(e)-g.load16(R(r))),t.ip++;break;case D.CMP_ADDRESS_WITH_REG:e=o(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,_(l(e)-g.load16(i)),t.ip++;break;case D.CMP_NUMBER_WITH_REG:e=o(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,_(l(e)-p),t.ip++;break;case D.JMP_REGADDRESS:e=s(g.load16(++t.ip)),t.ip++,d(t.gpr[e]);break;case D.JMP_ADDRESS:p=g.load16(++t.ip),t.ip++,d(p);break;case D.JC_REGADDRESS:e=s(g.load16(++t.ip)),t.ip++,t.carry?d(t.gpr[e]):t.ip++;break;case D.JC_ADDRESS:p=g.load16(++t.ip),t.ip++,t.carry?d(p):t.ip++;break;case D.JNC_REGADDRESS:e=s(g.load16(++t.ip)),t.ip++,t.carry?t.ip++:d(t.gpr[e]);break;case D.JNC_ADDRESS:p=g.load16(++t.ip),t.ip++,t.carry?t.ip++:d(p);break;case D.JZ_REGADDRESS:e=s(g.load16(++t.ip)),t.ip++,t.zero?d(t.gpr[e]):t.ip++;break;case D.JZ_ADDRESS:p=g.load16(++t.ip),t.ip++,t.zero?d(p):t.ip++;break;case D.JNZ_REGADDRESS:e=s(g.load16(++t.ip)),t.ip++,t.zero?t.ip++:d(t.gpr[e]);break;case D.JNZ_ADDRESS:p=g.load16(++t.ip),t.ip++,t.zero?t.ip++:d(p);break;case D.JA_REGADDRESS:e=s(g.load16(++t.ip)),t.ip++,t.zero||t.carry?t.ip++:d(t.gpr[e]);break;case D.JA_ADDRESS:p=g.load16(++t.ip),t.ip++,t.zero||t.carry?t.ip++:d(p);break;case D.JNA_REGADDRESS:e=s(g.load16(++t.ip)),t.ip++,t.zero||t.carry?d(t.gpr[e]):t.ip++;break;case D.JNA_ADDRESS:p=g.load16(++t.ip),t.ip++,t.zero||t.carry?d(p):t.ip++;break;case D.PUSH_REG:r=s(g.load16(++t.ip)),t.ip++,c(t.gpr[r]),t.ip++;break;case D.PUSH_REGADDRESS:r=g.load16(++t.ip),t.ip++,c(g.load16(R(r))),t.ip++;break;case D.PUSH_ADDRESS:i=g.load16(++t.ip),t.ip++,c(g.load16(i)),t.ip++;break;case D.PUSH_NUMBER:p=g.load16(++t.ip),t.ip++,c(p),t.ip++;break;case D.POP_REG:e=s(g.load16(++t.ip)),t.ip++,t.gpr[e]=E(),t.ip++;break;case D.CALL_REGADDRESS:e=s(g.load16(++t.ip)),c(t.ip+2),d(t.gpr[e]);break;case D.CALL_ADDRESS:p=g.load16(++t.ip),c(t.ip+2),d(p);break;case D.RET:d(jump_addr=E());break;case D.MUL_REG:r=s(g.load16(++t.ip)),t.ip++,t.gpr[0]=_(t.gpr[0]*t.gpr[r]),t.ip++;break;case D.MUL_REGADDRESS:r=g.load16(++t.ip),t.ip++,t.gpr[0]=_(t.gpr[0]*g.load16(R(r))),t.ip++;break;case D.MUL_ADDRESS:i=g.load16(++t.ip),t.ip++,t.gpr[0]=_(t.gpr[0]*g.load16(i)),t.ip++;break;case D.MUL_NUMBER:p=g.load16(++t.ip),t.ip++,t.gpr[0]=_(t.gpr[0]*p),t.ip++;break;case D.DIV_REG:r=s(g.load16(++t.ip)),t.ip++,t.gpr[0]=_(S(t.gpr[r])),t.ip++;break;case D.DIV_REGADDRESS:r=g.load16(++t.ip),t.ip++,t.gpr[0]=_(S(g.load16(R(r)))),t.ip++;break;case D.DIV_ADDRESS:i=g.load16(++t.ip),t.ip++,t.gpr[0]=_(S(g.load16(i))),t.ip++;break;case D.DIV_NUMBER:p=g.load16(++t.ip),t.ip++,t.gpr[0]=_(S(p)),t.ip++;break;case D.AND_REG_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=s(g.load16(++t.ip)),t.ip++,t.gpr[e]=_(t.gpr[e]&t.gpr[r]),t.ip++;break;case D.AND_REGADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]&g.load16(R(r))),t.ip++;break;case D.AND_ADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]&g.load16(i)),t.ip++;break;case D.AND_NUMBER_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]&p),t.ip++;break;case D.OR_REG_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=s(g.load16(++t.ip)),t.ip++,t.gpr[e]=_(t.gpr[e]|t.gpr[r]),t.ip++;break;case D.OR_REGADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]|g.load16(R(r))),t.ip++;break;case D.OR_ADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]|g.load16(i)),t.ip++;break;case D.OR_NUMBER_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]|p),t.ip++;break;case D.XOR_REG_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=s(g.load16(++t.ip)),t.ip++,t.gpr[e]=_(t.gpr[e]^t.gpr[r]),t.ip++;break;case D.XOR_REGADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]^g.load16(R(r))),t.ip++;break;case D.XOR_ADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]^g.load16(i)),t.ip++;break;case D.XOR_NUMBER_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]^p),t.ip++;break;case D.NOT_REG:e=s(g.load16(++t.ip)),t.ip++,t.gpr[e]=_(~t.gpr[e]),t.ip++;break;case D.SHL_REG_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=s(g.load16(++t.ip)),t.ip++,t.gpr[e]=_(t.gpr[e]<<t.gpr[r]),t.ip++;break;case D.SHL_REGADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]<<g.load16(R(r))),t.ip++;break;case D.SHL_ADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]<<g.load16(i)),t.ip++;break;case D.SHL_NUMBER_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]<<p),t.ip++;break;case D.SHR_REG_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=s(g.load16(++t.ip)),t.ip++,t.gpr[e]=_(t.gpr[e]>>>t.gpr[r]),t.ip++;break;case D.SHR_REGADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,r=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]>>>g.load16(R(r))),t.ip++;break;case D.SHR_ADDRESS_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,i=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]>>>g.load16(i)),t.ip++;break;case D.SHR_NUMBER_WITH_REG:e=s(g.load16(++t.ip)),t.ip++,p=g.load16(++t.ip),t.ip++,t.gpr[e]=_(t.gpr[e]>>>p),t.ip++;break;default:throw"Invalid op code: "+u}return!0}catch(e){throw t.fault=!0,e}},reset:function(){var e=this;e.maxSP=924,e.minSP=0,e.gpr=[0,0,0,0],e.sp=e.maxSP,e.ip=0,e.zero=!1,e.carry=!1,e.fault=!1}};return e.reset(),e}]),app.service("memory",[function(){var e={data:Array(1024),lastAccess:-1,load:function(e){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;return this.lastAccess=e,this.data[e]},load16:function(e){if(e<0||e+1>=this.data.length)throw"Memory access violation at "+e;return this.lastAccess=e,(this.data[e]<<8)+this.data[e+1]},store:function(e,r){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;this.lastAccess=e,this.data[e]=r},store16:function(e,r){if(e<0||e+1>=this.data.length)throw"Memory access violation at "+e;this.lastAccess=e,this.data[e]=r>>8&255,this.data[e+1]=255&r},reset:function(){this.lastAccess=-1;for(var e=0,r=this.data.length;e<r;e++)this.data[e]=0}};return e.reset(),e}]),app.service("opcodes",[function(){return{NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97}}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(r,a,e,t,p,s){var i;a.memory=p,a.cpu=t,a.error="",a.isRunning=!1,a.displayHex=!0,a.displayInstr=!0,a.displayA=!0,a.displayB=!0,a.displayC=!0,a.displayD=!0,a.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"},{speed:1024,desc:"1024 HZ"}],a.speed=4,a.outputStartIndex=925,a.ramDisplayMode="HEX",a.code=["; Simple example","; Writes Hello World to the output","   JMP start",'hello: DB "Hello World!" ; Variable',"       DB 0\t; String terminator","start:","   MOV D, hello    ; Point to var","   PUSH 925\t; Point to output","   CALL print","   HLT             ; Stop execution","print:\t\t; print(D:*from, SP+2:*to)","   PUSH C","   PUSH B","   MOV C, [SP+6]","   MOV B, 0",".loop:","   MOV A, [D]\t; Get char from var","   MOV [C], A\t; Write to output","   INC D","   INC C","   INC D","   INC C","   CMP B, [D]\t; Check if end","   JNZ .loop\t; jump if not","   POP B","   POP C","   RET"].join("\n"),a.syncScroll=function(){var e=document.querySelector(".code-input"),r=document.querySelector(".highlighted-code");e&&r&&(r.scrollTop=e.scrollTop,r.scrollLeft=e.scrollLeft,r.offsetHeight)},a.$watch("code",function(e,r){e!==r&&a.syncScroll()}),a.reset=function(){t.reset(),p.reset(),a.error="",a.selectedLine=-1},a.downloadCode=function(){var e=document.createElement("a"),r=a.code,r=new Blob([r],{type:"text/plain"});e.href=URL.createObjectURL(r),e.download="code.asm",document.body.appendChild(e),e.click(),URL.revokeObjectURL(e.href),document.body.removeChild(e)},a.loadFile=function(){var e=document.querySelector("input").files[0],r=(console.log(e),new FileReader);r.addEventListener("load",function(e){a.code=e.target.result,a.$apply()}),r.readAsText(e,"UTF-8")},a.executeStep=function(){a.checkPrgrmLoaded()||a.assemble();try{var e=t.step();return t.ip in a.mapping&&(a.selectedLine=a.mapping[t.ip]),e}catch(e){return a.error=e,!1}},a.run=function(){a.checkPrgrmLoaded()||a.assemble(),a.isRunning=!0,i=e(function(){!0===a.executeStep()?a.run():a.isRunning=!1},1e3/a.speed)},a.runQuickly=function(){a.checkPrgrmLoaded()||a.assemble(),a.isRunning=!0,i=e(function(){!0===a.executeStep()?a.runQuickly():a.isRunning=!1},1)},a.stop=function(){e.cancel(i),a.isRunning=!1},a.checkPrgrmLoaded=function(){for(var e=0,r=p.data.length;e<r;e++)if(0!==p.data[e])return!0;return!1},a.getChar=function(e){e=String.fromCharCode(e);return""===e.trim()?"  ":e},a.get8HigherBits=function(e){return e>>8&255},a.get8LowerBits=function(e){return 255&e},a.assemble=function(){try{a.reset();var e=s.go(a.code),r=(a.mapping=e.mapping,e.code);if(a.labels=e.labels,r.length>p.data.length)throw"Binary code does not fit into the memory. Max "+p.data.length+" bytes are allowed";for(var t=0,i=r.length;t<i;t++)p.data[t]=r[t]}catch(e){void 0!==e.line?(a.error=e.line+" | "+e.error,a.selectedLine=e.line):a.error=e.error}},a.jumpToLine=function(e){r[0].getElementById("sourceCode").scrollIntoView(),a.selectedLine=a.mapping[e]},a.isInstruction=function(e){return void 0!==a.mapping&&void 0!==a.mapping[e]&&a.displayInstr},a.getMemoryCellCss=function(e){return e>=a.outputStartIndex?"output-bg":a.isInstruction(e)?"instr-bg":e>t.sp&&e<=t.maxSP?"stack-bg":""},a.getMemoryInnerCellCss=function(e){return e===t.ip?"marker marker-ip":e===t.sp?"marker marker-sp":e===t.gpr[0]&&a.displayA?"marker marker-a":e===t.gpr[1]&&a.displayB?"marker marker-b":e===t.gpr[2]&&a.displayC?"marker marker-c":e===t.gpr[3]&&a.displayD?"marker marker-d":""},a.changeRamDisplayMode=function(){"ASCII"===a.ramDisplayMode?a.ramDisplayMode="HEX":a.ramDisplayMode="ASCII"}}]),app.filter("flag",function(){return function(e){return e.toString().toUpperCase()}}),app.directive("newLineSupport",["$log",function(n){return{restrict:"A",require:"ngModel",link:function(p,s,e,o){s.bind("keydown",function(e){var r,t,i,a;if(13===e.keyCode)return r=s.val(),t=s[0].selectionStart,i=s[0].selectionEnd,a=r.substring(0,t)+"\n"+r.substring(i),p.$apply(function(){o.$setViewValue(a),o.$render()}),s[0].selectionStart=s[0].selectionEnd=t+1,n.log("new line added",a),e.preventDefault(),!1})}}}]),app.filter("number",function(){return function(e,r){return r?1==(r=e.toString(16).toUpperCase()).length?"0"+r:r:e.toString(10)}}),app.directive("resizeSync",["$window",function(s){return{restrict:"A",link:function(e,t,r){var i,a=angular.element(document.querySelector(".highlighted-code")),p=angular.element(document.querySelector(".editor-container"));p.parent();s.ResizeObserver?((i=new ResizeObserver(function(e){for(var r=0;r<e.length;r++){var t=e[r],i=t.target.offsetHeight,t=t.target.offsetWidth;a.css({width:t+"px",height:i+"px"}),p.css({width:t+"px",height:i+"px"})}})).observe(t[0]),e.$on("$destroy",function(){i.disconnect()})):t.on("mouseup",function(){var e=t[0].offsetHeight,r=t[0].offsetWidth;a.css({width:r+"px",height:e+"px"}),p.css({width:r+"px",height:e+"px"})}),a.css({width:t[0].offsetWidth+"px",height:t[0].offsetHeight+"px"})}}}]),app.directive("scrollSync",["$log",function(e){return{restrict:"A",link:function(e,r,t){r.on("scroll mousemove mouseup",function(){e.$apply(function(){e.$eval(t.scrollSync)})})}}}]),app.directive("selectLine",[function(){return{restrict:"A",link:function(p,s,e,r){p.$watch("selectedLine",function(){if(0<=p.selectedLine){for(var e=s[0].value.split("\n"),r=0,t=0;t<e.length&&t!=p.selectedLine;t++)r+=e[t].length+1;var i,a=e[p.selectedLine].length+r;void 0!==s[0].selectionStart&&(s[0].focus(),s[0].selectionStart=r,s[0].selectionEnd=a),document.selection&&document.selection.createRange&&(s[0].focus(),s[0].select(),(i=document.selection.createRange()).collapse(!0),i.moveEnd("character",a),i.moveStart("character",r),i.select())}})}}}]),app.filter("startFrom",function(){return function(e,r){return e.slice(r=+r)}}),app.filter("syntaxHighlight",["$log","$sce",function(e,a){return function(e){var t,i,r;return e?(r=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),t=[],i=[],r=(r=(r=(r=(r=(r=(r=r.replace(/(;.*)$/gm,function(e){var r="COMMENT_"+t.length;return t.push({id:r,text:e}),r})).replace(/"([^"]*)"/g,function(e){var r="STRING_"+i.length;return i.push({id:r,text:e}),r})).replace(/\b\d+\b/g,'<span class="num">$&</span>')).replace(/0x[0-9A-Fa-f]+/g,'<span class="hexa">$&</span>')).replace(/\[([^\]]+)\]/g,'<span class="addr">[$1]</span>')).replace(/(MOV|ADD|SUB|INC|DEC|CMP|JMP|JC|JNC|JZ|JNZ|JA|JNA|PUSH|POP|CALL|RET|MUL|DIV|AND|OR|XOR|NOT|SHL|SHR|HLT|DB)/g,'<span class="function">$1</span>')).replace(/^\s*([A-Za-z_\.][A-Za-z0-9_\.]*)\s*:/gm,'<span class="var">$1:</span>'),i.forEach(function(e){r=r.replace(e.id,'<span class="string">'+e.text+"</span>")}),t.forEach(function(e){r=r.replace(e.id,'<span class="comment">'+e.text+"</span>")}),a.trustAsHtml(r)):""}}]),app.directive("tabSupport",[function(){return{restrict:"A",link:function(e,r,t,i){r.bind("keydown",function(e){var r,t,i;if(9===e.keyCode)return r=this.value,t=this.selectionStart,i=this.selectionEnd,this.value=r.substring(0,t)+"\t"+r.substring(i),this.selectionStart=this.selectionEnd=t+1,e.preventDefault(),!1})}}}]);